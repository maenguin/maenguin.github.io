# 프록시와 연관관계 관리
## 프록시
실제 클래스를 상속 받아서 만들어진 가짜 객체  

### 프록시의 특징
* 프록시 객체는 처음 사용할 때 한 번만 초기화
* 프록시 객체를 초기화 할 때, 프록시 객체가 실제 엔티티로 바뀌는 것은 아님, 초기화되면 프록시 객체를 통해서 실제 엔티티에 접근 가능
  ```java
  Member refMember = em.getReference(Member.class, member.getId);
  System.out.println(refMember.getClass()); //class x.Member$HibernateProxy$xxxxxxx
  refMember.getName();
  System.out.println(refMember.getClass()); //class x.Member$HibernateProxy$xxxxxxx
  ```
* 프록시 객체는 원본 엔티티를 상속받음, 따라서 **타입 체크시 주의**해야함(== 대신 instanceof 사용)
  ```java
  Member member1 = em.find(Member.class, member1.getId());
  Member member2 = em.getReference(Member.class, member2.getId);
  System.out.println(member1.getClass() == member2.getClass()); //false
  System.out.println(member2.getClass() instanceof Member);     //true
  ```
* 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 **em.getReference()를 호출해도 실제 엔티티 반환, 그 반대도 마찬가지**
  ```java
  Member findMember = em.find(Member.class, member.getId());
  System.out.println(findMember.getClass() == refMember.getClass()); //class x.Member
  Member refMember = em.getReference(Member.class, member.getId);
  System.out.println(refMember.getClass() instanceof Member);        //class x.Member
  System.out.println(findMember.getClass() == refMember.getClass()); //true
  ```
  ```java
  Member refMember = em.getReference(Member.class, member.getId());
  System.out.println(findMember.getClass() == refMember.getClass()); //class x.Member$HibernateProxy$xxxxxxx
  Member findMember = em.find(Member.class, member.getId);
  System.out.println(refMember.getClass() instanceof Member);        //class x.Member$HibernateProxy$xxxxxxx
  System.out.println(findMember.getClass() == refMember.getClass()); //true
  ```
  > JPA는 객체패러다임을 준수하기 위해 한 영속성 컨텍스트에서 관리되는 엔티티는 같은 엔티티라면 == 비교시 무조건 true가 되도록 동작해야하기 때문  
* 영속성 컨텍스트의 도움을 받을 수 없는 준영속 상태일 때, 프록시를 초기화하면 문제 발생
  ```java
  Member refMember = em.getReference(Member.class, member.getId());
  em.detach(refMember); //or em.close() em.clear()
  refMember.getName();  //throw org.hibernate.LazyInitializationException
  ```
### 프록시 유틸 메소드
* **프록시 인스턴의 초기화 여부 확인**  
  emf.getPersistenceUnitUtil().isLoaded(entity)
* **프록시 강제 초기화**  
  org.hibernate.Hibernate.initialize(entity)  
> JPA 표준은 강제 초기화가 없어서 entity.getName()식으로 해줘야됨  


  
  
